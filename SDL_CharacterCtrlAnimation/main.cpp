#include <stdio.h>
#include <math.h>
#include <stdlib.h>
#include <ctime>
#include <chrono>
#include <thread>
#include <SDL2/SDL.h>
#include <SDL2/SDL_render.h>
#include <SDL2/SDL_events.h>
#include <SDL2/SDL_mouse.h>
#include <SDL2/SDL_keyboard.h>

//Screen dimension constants
const int SCREEN_WIDTH = 640;
const int SCREEN_HEIGHT = 480;

const int XCenter = SCREEN_WIDTH/2;
const int YCenter = SCREEN_HEIGHT/2;
bool first = true;
int angle = 0;
int l = 0;

unsigned int start_time;

const int lvlSideCount = 40;

char level[lvlSideCount][lvlSideCount] {
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*','*',
    '3','4','3','4','3','4','3','4','3','4','3','4','3','4','3','4','3','4','3','4','3','4','3','4','3','4','3','4','3','4','3','4','3','4','3','4','3','4','3','4',
    '2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3',
    '2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3','2','3',
    '1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0',
    '1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0',
    '0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1',
    '0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1','0','0','1','1'
};

char player[12][12] = {
    ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',
    ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',
    ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',
    ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',
    ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',
    ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',
    ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',
    ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',
    ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',
    ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',
    ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',
    ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' '
};

char cloud[6][12] = {
    ' ',' ',' ','*','*','*','*','*','*',' ',' ',' ',
    ' ','*','*','*','*','*','*','*','*','*','*',' ',
    '*','*','*','*','*','*','*','*','*','*','*','*',
    '*','*','*','*','*','*','*','*','*','*','*','*',
    ' ','*','*','*','*','*','*','*','*','*','*',' ',
    ' ',' ',' ','*','*','*','*','*','*',' ',' ',' '
};

int xStart, cloudStart;

void getXandYNextStep(int &x, int &y, bool first);
bool drawCircle(SDL_Renderer* renderer, int X0, int Y0, int Radius);
void updateScreen(SDL_Renderer* renderer,int width, int height);

static int process_events(void)
{
    SDL_Event event;
    int ret = 1;

    unsigned int cur_time = clock();

    if (cur_time - start_time >= 1000)
    {
        cloudStart++;
        if (cloudStart%lvlSideCount == 0)
            cloudStart = 0;
    }

    while ( SDL_PollEvent(&event) >= 1)
    {
        switch(event.type)
        {
        case SDL_KEYDOWN:
            if (event.key.keysym.sym == SDLK_LEFT)
            {
                xStart = xStart - 1;
                if (xStart < 0)
                    xStart = lvlSideCount - 1;
                if (xStart%lvlSideCount == 0)
                    xStart = 0;
            }

            if (event.key.keysym.sym == SDLK_RIGHT)
            {
                xStart = xStart + 1;
                if (xStart < 0)
                    xStart = lvlSideCount - 1;
                if (xStart%lvlSideCount == 0)
                    xStart = 0;
            }

            if (event.key.keysym.sym == SDLK_ESCAPE)
                ret = 0;
            break;
        /*case SDL_MOUSEMOTION:
            XBegin = event.motion.x - width/2;
            if (XBegin < 0)
                XBegin = 0;
            if (XBegin > SCREEN_WIDTH - width)
                XBegin = SCREEN_WIDTH - width;
            break;*/
        default:
            break;
        }
    }
    return ret;
}

int main( int argc, char* args[] )
{
    start_time = clock();

    cloudStart = 0;

    //The window we'll be rendering to
	SDL_Window* window = NULL;
	SDL_Renderer* renderer = NULL;

	int width = 200;
    int height = 50;
    xStart = 0;

	//Initialize SDL
	if( SDL_Init( SDL_INIT_VIDEO ) < 0 )
	{
		printf( "SDL could not initialize! SDL_Error: %s\n", SDL_GetError() );
	}
	else
	{
		//Create window
		window = SDL_CreateWindow( "SDL Character Control and Animation", SDL_WINDOWPOS_UNDEFINED, SDL_WINDOWPOS_UNDEFINED, SCREEN_WIDTH, SCREEN_HEIGHT, SDL_WINDOW_SHOWN );
		if( window == NULL )
        {
            printf( "Window could not be created! SDL_Error: %s\n", SDL_GetError() );
        }
        else
        {
            renderer = SDL_CreateRenderer( window, -1, SDL_RENDERER_ACCELERATED);

            while(process_events())
            {
                updateScreen(renderer,width,height);
            }
        }
	}

	//Destroy window
	SDL_DestroyWindow( window );

	//Quit SDL subsystems
	SDL_Quit();

	return 0;
}

void updateScreen(SDL_Renderer* renderer,int width, int height)
{
    SDL_Rect lvlBrick;

    int SideSize = 0;

    if(SCREEN_HEIGHT < SCREEN_WIDTH)
        SideSize = SCREEN_HEIGHT / lvlSideCount;
    else SideSize = SCREEN_WIDTH / lvlSideCount;

    for(int i=0;i<lvlSideCount;i++)
    {
        for(int j=0;j<lvlSideCount;j++)
        {
            int t = j + xStart;

            if (t >= lvlSideCount)
                t = t - lvlSideCount;
            if (t < 0)
                t = lvlSideCount + t;

            lvlBrick.x = j * SideSize;
            lvlBrick.y = i * SideSize;
            lvlBrick.h = SideSize;
            lvlBrick.w = SideSize;

            if (level[i][t] == '0')
                SDL_SetRenderDrawColor( renderer, 0, 0, 0, 255 );
            else if (level[i][t] == '1')
                SDL_SetRenderDrawColor( renderer, 91, 66, 21, 255 );
            else // Трава
            if (level[i][t] == '2')
                SDL_SetRenderDrawColor( renderer, 22, 78, 39, 255 );
            else if (level[i][t] == '3')
                SDL_SetRenderDrawColor( renderer, 15, 204, 37, 255 );
            else if (level[i][t] == '4')
                SDL_SetRenderDrawColor( renderer, 115, 255, 82, 255 );
            else // Небо
            if (level[i][t] == '*')
                SDL_SetRenderDrawColor( renderer, 122, 191, 255, 255 );

            // Облако
            int p = j + cloudStart;
            if (p >= lvlSideCount)
                p = p - lvlSideCount;
            if (p < 0)
                p = lvlSideCount + p;
            if (i < 6 && p < 12)
                if(cloud[i][p] == '*')
                    SDL_SetRenderDrawColor( renderer, 255, 255, 255, 255 );


            SDL_RenderFillRect(renderer, &lvlBrick);
            SDL_RenderPresent(renderer);
        }
    }
    std::this_thread::sleep_for(std::chrono::milliseconds(50));
}

void getXandYNextStep(int &x, int &y, bool first)
{
    if(first)
    {
        x = XCenter;
        y = YCenter;
        l = 0;
        srand(time(NULL));
        angle = rand()%360;
    }
    else
    {
        l = l + 1;
        x = x + cos(angle)*l;
        y = y + sin(angle)*l;
    }
}

bool drawCircle(SDL_Renderer* renderer, int X0, int Y0, int Radius)
{
    // Вернет True, если надо вернуть в центр(ушло за грани верха и низа)
    int MinY = Y0+sin(0)*Radius;
    int MaxY = Y0+sin(0)*Radius;
    for(int i=0;i<360;i++)
    {
        int XDest = X0+cos(i)*Radius;
        int YDest = Y0+sin(i)*Radius;
        SDL_RenderDrawLine(renderer,X0,Y0,XDest,YDest);

        if(YDest < MinY)
            MinY = YDest;
        if(YDest > MaxY)
            MaxY = YDest;
    }

    if(MinY < 0 || MaxY > SCREEN_HEIGHT)
        return true;
    else return false;

}
